name: Build and Release

on:
  push:
    tags:
      - 'v*'  # è§¦å‘æ¡ä»¶ï¼šæ¨é€ç‰ˆæœ¬æ ‡ç­¾ (v1.0.0, v2.1.3, etc.)
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-and-release:
    permissions:
      contents: write  # éœ€è¦å†™æƒé™æ¥åˆ›å»ºå‘å¸ƒ
    strategy:
      fail-fast: false
      matrix:
        include:
          # macOS æ„å»º
          - platform: "macos-latest"
            args: "--target aarch64-apple-darwin"
            target: "aarch64-apple-darwin"
            arch: "arm64"
            os: "macos"
          - platform: "macos-latest"
            args: "--target x86_64-apple-darwin"
            target: "x86_64-apple-darwin"
            arch: "x64"
            os: "macos"
          
          # Windows æ„å»º
          - platform: "windows-latest"
            args: "--target x86_64-pc-windows-msvc"
            target: "x86_64-pc-windows-msvc"
            arch: "x64"
            os: "windows"
          
          # Linux æ„å»º
          - platform: "ubuntu-latest"
            args: "--target x86_64-unknown-linux-gnu"
            target: "x86_64-unknown-linux-gnu"
            arch: "x64"
            os: "linux"

    runs-on: ${{ matrix.platform }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºç‰ˆæœ¬ä¿¡æ¯

      - name: Install system dependencies (macOS)
        if: matrix.platform == 'macos-latest'
        run: |
          # macOS é€šå¸¸ä¸éœ€è¦é¢å¤–ä¾èµ–ï¼ŒXcode Command Line Tools å·²é¢„å®‰è£…
          echo "macOS dependencies already available"

      - name: Install system dependencies (Windows)
        if: matrix.platform == 'windows-latest'
        run: |
          # Windows è¿è¡Œå™¨å·²é¢„è£… MSVC å’Œ WebView2
          echo "Windows dependencies already available"
          # ç¡®ä¿ PowerShell æ‰§è¡Œç­–ç•¥å…è®¸è„šæœ¬è¿è¡Œ
          Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser -Force

      - name: Install system dependencies (Linux)
        if: matrix.platform == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.0-dev libappindicator3-dev librsvg2-dev patchelf
          # å®‰è£…é¢å¤–çš„ç³»ç»Ÿå·¥å…·
          sudo apt-get install -y build-essential curl wget file

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Setup Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: './tauri-app/src-tauri -> target'
          key: ${{ matrix.target }}
          cache-targets: true
          cache-all-crates: true

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9
          run_install: false

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'pnpm'
          cache-dependency-path: './tauri-app/pnpm-lock.yaml'

      - name: Install frontend dependencies
        working-directory: ./tauri-app
        run: pnpm install --frozen-lockfile

      - name: Build Tauri application
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # å¯é€‰ï¼šä»£ç ç­¾åè¯ä¹¦ (macOS)
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          # å¯é€‰ï¼šWindows ä»£ç ç­¾å
          WINDOWS_CERTIFICATE: ${{ secrets.WINDOWS_CERTIFICATE }}
          WINDOWS_CERTIFICATE_PASSWORD: ${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}
        with:
          projectPath: ./tauri-app
          tagName: ${{ github.ref_name }}  # ä½¿ç”¨æ¨é€çš„æ ‡ç­¾ä½œä¸ºå‘å¸ƒæ ‡ç­¾
          releaseName: "OpenWrt Builder ${{ github.ref_name }}"
          releaseBody: |
            ## ğŸ‰ OpenWrt Builder ${{ github.ref_name }}
            
            ### ğŸ“¦ ä¸‹è½½é“¾æ¥
            
            | å¹³å° | æ¶æ„ | ä¸‹è½½é“¾æ¥ |
            |------|------|----------|
            | macOS | Apple Silicon (M1/M2) | [.dmg](ä¸‹è½½é“¾æ¥å°†è‡ªåŠ¨ç”Ÿæˆ) |
            | macOS | Intel | [.dmg](ä¸‹è½½é“¾æ¥å°†è‡ªåŠ¨ç”Ÿæˆ) |
            | Windows | x64 | [.msi](ä¸‹è½½é“¾æ¥å°†è‡ªåŠ¨ç”Ÿæˆ) |
            | Linux | x64 | [.deb / .AppImage](ä¸‹è½½é“¾æ¥å°†è‡ªåŠ¨ç”Ÿæˆ) |
            
            ### ğŸš€ æ–°ç‰¹æ€§
            - âœ… å®Œæ•´çš„ Windows æ”¯æŒ
            - âœ… Linux æ¡Œé¢åº”ç”¨æ”¯æŒ (.deb/.AppImage)
            - âœ… PowerShell è„šæœ¬æ„å»ºæ”¯æŒ
            - âœ… è·¨å¹³å°ç»Ÿä¸€ä½“éªŒ
            
            ### ğŸ“‹ ç³»ç»Ÿè¦æ±‚
            - **macOS**: macOS 10.15+ (Catalina)
            - **Windows**: Windows 10/11 + Docker Desktop
            - **Linux**: Ubuntu 18.04+ / å…¶ä»–ä¸»æµå‘è¡Œç‰ˆ + Docker
            - **æ‰€æœ‰å¹³å°**: éœ€è¦å®‰è£…å¹¶è¿è¡Œ Docker
            
            ### ğŸ”§ ä½¿ç”¨æ–¹æ³•
            1. å®‰è£…å¹¶å¯åŠ¨ Docker Desktop
            2. ä¸‹è½½å¯¹åº”å¹³å°çš„å®‰è£…åŒ…
            3. å®‰è£…å¹¶è¿è¡Œ OpenWrt Builder
            4. åœ¨å›¾å½¢ç•Œé¢ä¸­é…ç½®å¹¶æ„å»ºå›ºä»¶
            
            æˆ–ä½¿ç”¨å‘½ä»¤è¡Œï¼š
            ```bash
            # Linux/macOS
            ./run.sh --image=immortalwrt/imagebuilder:x86-64-openwrt-23.05.1 --with-pull
            
            # Windows PowerShell  
            .\run.ps1 -Image "immortalwrt/imagebuilder:x86-64-openwrt-23.05.1" -WithPull
            ```
            
            ### ğŸ“¦ Linux å®‰è£…è¯´æ˜
            - **.deb åŒ…**: `sudo dpkg -i openwrt-builder_*.deb && sudo apt-get install -f`
            - **.AppImage**: `chmod +x OpenWrt-Builder-*.AppImage && ./OpenWrt-Builder-*.AppImage`
          releaseDraft: false  # è‡ªåŠ¨å‘å¸ƒ
          prerelease: false    # æ­£å¼å‘å¸ƒ
          includeUpdaterJson: true  # åŒ…å«è‡ªåŠ¨æ›´æ–°ä¿¡æ¯
          args: ${{ matrix.args }}

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ matrix.os }}-${{ matrix.arch }}
          path: |
            ./tauri-app/src-tauri/target/${{ matrix.target }}/release/bundle/
            ./tauri-app/src-tauri/target/${{ matrix.target }}/release/*.exe
            ./tauri-app/src-tauri/target/${{ matrix.target }}/release/*.app
          retention-days: 30